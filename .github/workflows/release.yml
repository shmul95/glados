name: Stable Release

on:
  pull_request:
    types: [closed]

permissions:
  contents: write

jobs:
  build:
    if: github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build binaries
        run: |
          make
          mkdir -p output
          cp glados output/glados-linux
          cp rune output/rune-linux

      - name: Upload binaries as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries
          path: output/*

  release:
    if: github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'main'
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download binaries
        uses: actions/download-artifact@v4
        with:
          name: binaries
          path: output

      - name: Read current version
        id: version
        run: |
          VERSION=$(cat VERSION.md | sed 's/^v//')
          echo "current=$VERSION" >> $GITHUB_OUTPUT

      - name: Bump version (stable release)
        id: bump
        run: |
          NEW_VERSION=$(./scripts/git_scripts/bump_version.sh "${{ github.event.pull_request.title }}")
          if [[ -z "$NEW_VERSION" ]]; then
            echo "No version bump required"
            exit 0
          fi
          echo "$NEW_VERSION" > VERSION.md
          echo "new=$NEW_VERSION" >> $GITHUB_OUTPUT
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add VERSION.md
          git commit -m "chore(release): bump version to v$NEW_VERSION"
          git push origin main

      - name: Create Git tag
        if: steps.bump.outputs.new != ''
        run: |
          git tag "v${{ steps.bump.outputs.new }}"
          git push origin "v${{ steps.bump.outputs.new }}"

      - name: Install GitHub CLI
        if: steps.bump.outputs.new != ''
        run: |
          sudo apt update
          sudo apt install -y gh

      - name: Authenticate GitHub CLI
        if: steps.bump.outputs.new != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh auth setup-git

      - name: Create GitHub Release
        if: steps.bump.outputs.new != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "v${{ steps.bump.outputs.new }}" \
            --title "v${{ steps.bump.outputs.new }} (Stable Release)" \
            --notes "Release generated from merge of PR: ${{ github.event.pull_request.title }}" \
            output/*
